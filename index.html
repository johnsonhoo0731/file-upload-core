<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div>
    <input type="file" class="file">
  </div>
  <script>
    const input = document.querySelector('.file');
    input.addEventListener('change', async e => {
      const file = e.target.files[0];
      const filename = file.name;
      // console.log(Object.prototype.toString.call(file));
      let cur = 0;
      const SIZE = 5 * 1024 * 1024, fileChunkList = [];
      while(cur <= file.size) {
        fileChunkList.push({
          file: file.slice(cur, cur + SIZE)
        })
        cur += SIZE;
      }
      console.log(fileChunkList);
      const requestList = fileChunkList.map(({ file }, index) => {
        const formData = new FormData();
        formData.append("chunk", file);
        formData.append("filename", filename + '-' + index);
        return { formData };
      })
      .map(async ({ formData }) => 
        request({
          url: 'http://localhost:3000/',
          data: formData
        })
      )
      await Promise.all(requestList); // 并发请求
      // 发送合并请求
      await mergeRequest(filename);
    })

    function request({
      url,
      method = 'POST',
      data,
      headers = {},
      requestList = []
    }) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open(method, url);
        Object.keys(headers).forEach(key => xhr.setRequestHeader(key, headers[key]))
        xhr.send(data);
        xhr.onload = e => {
          resolve({
            data: e.target.response
          })
        }
      })
    }

    async function mergeRequest(filename) {
      await request({
        url: 'http://localhost:3000/merge',
        headers: {
          "content-type": "application/json"
        },
        data: filename
      });
    }
  </script>
</body>
</html>